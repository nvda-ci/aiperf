# SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
# yaml-language-server: $schema=../plugin/schema/plugins.schema.json

schema_version: "1.0"

# =============================================================================
# Services
# =============================================================================
# Services are the core processes that make up the AIPerf distributed system.
# Each service runs in a separate process and communicates via ZMQ message bus.
# =============================================================================
service:
  dataset_manager:
    class: aiperf.dataset.dataset_manager:DatasetManager
    description: |
      Dataset management service. Handles prompt/token generation, dataset loading
      and composition, conversation sampling, and distribution to timing manager.

# =============================================================================
# Dataset Composers
# =============================================================================
# Dataset composers create conversation datasets from various sources.
# One-to-one mapping: exactly one composer is selected based on composer_type config.
# =============================================================================
dataset_composer:
  custom:
    class: aiperf.dataset.composer.custom:CustomDatasetComposer
    description: |
      Custom dataset composer that loads conversations from JSONL files. Supports
      single-turn, multi-turn, random-pool, and mooncake-trace formats with
      automatic format detection.

  synthetic:
    class: aiperf.dataset.composer.synthetic:SyntheticDatasetComposer
    description: |
      Synthetic dataset composer that generates multi-turn conversations with
      synthetic text, image, and audio payloads using configurable distributions.
      Supports variable turn counts and delays.

  synthetic_rankings:
    class: aiperf.dataset.composer.synthetic_rankings:SyntheticRankingsDatasetComposer
    description: |
      Synthetic rankings dataset composer that generates ranking tasks with query
      and passage pairs for ranking model evaluation and benchmarking.

# =============================================================================
# Custom Dataset Loaders
# =============================================================================
# Custom dataset loaders parse different JSONL file formats into conversations.
# Auto-detection: the custom composer tries loaders in priority order based on can_load().
# =============================================================================
custom_dataset_loader:
  mooncake_trace:
    class: aiperf.dataset.loader.mooncake_trace:MooncakeTraceDatasetLoader
    description: |
      Mooncake trace dataset loader for loading Alibaba Mooncake trace format with
      timestamp-based replay support. Designed for fixed_schedule timing mode.

  multi_turn:
    class: aiperf.dataset.loader.multi_turn:MultiTurnDatasetLoader
    description: |
      Multi-turn dataset loader supporting conversation sessions with turn delays
      and multi-modal content. Enables realistic multi-turn conversation replay
      with session management.

  random_pool:
    class: aiperf.dataset.loader.random_pool:RandomPoolDatasetLoader
    description: |
      Random pool dataset loader that creates conversations by randomly sampling
      from predefined pools of system/user/assistant messages with configurable
      distributions.

  single_turn:
    class: aiperf.dataset.loader.single_turn:SingleTurnDatasetLoader
    description: |
      Single-turn dataset loader supporting multi-modal data and client-side
      batching. Supports text, images, audio with optional timestamps or delays.
      Does NOT support multi-turn features.

# =============================================================================
# Dataset Samplers
# =============================================================================
# Dataset samplers control how conversations are selected from the dataset.
# One-to-one mapping: exactly one sampler is selected based on sampling strategy.
# =============================================================================
dataset_sampler:
  random:
    class: aiperf.dataset.dataset_samplers:RandomSampler
    description: |
      Random sampler that randomly selects conversation IDs with replacement. Can
      return the same conversation ID multiple times before seeing all IDs. Uses
      derived RNG for reproducibility.

  sequential:
    class: aiperf.dataset.dataset_samplers:SequentialSampler
    description: |
      Sequential sampler that iterates through conversation IDs in order. When
      reaching the end, wraps around to the beginning indefinitely. Completely
      deterministic with no randomness.

  shuffle:
    class: aiperf.dataset.dataset_samplers:ShuffleSampler
    description: |
      Shuffle sampler that randomly samples without replacement, then repeats.
      Ensures all conversations are seen before any repetition, similar to music
      shuffle. Uses derived RNG for reproducibility.

# =============================================================================
# Dataset Backing Store
# =============================================================================
# Dataset backing stores manage conversation data on the DatasetManager side.
# Provides efficient storage and retrieval for dataset distribution to workers.
# =============================================================================
dataset_backing_store:
  memory_map:
    class: aiperf.dataset.memory_map_utils:MemoryMapDatasetBackingStore
    description: |
      Memory-mapped file backing store for zero-copy worker access. Stores dataset
      in memory-mapped files for efficient sharing across processes.

# =============================================================================
# Dataset Client Store
# =============================================================================
# Dataset client stores read conversation data on the Worker side.
# Provides efficient access to dataset from memory-mapped backing stores.
# =============================================================================
dataset_client_store:
  memory_map:
    class: aiperf.dataset.memory_map_utils:MemoryMapDatasetClientStore
    description: |
      Memory-mapped file client store for zero-copy reads. Reads from memory-mapped
      files with O(1) lookup performance.
