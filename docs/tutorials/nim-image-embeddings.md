<!--
SPDX-FileCopyrightText: Copyright (c) 2025-2026 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
SPDX-License-Identifier: Apache-2.0
-->

# Profile NIM Image Embeddings with AIPerf

AIPerf supports benchmarking NVIDIA NIM Image Embeddings endpoints, such as **C-RADIOv3-H**,
which provides high-quality 1024-dimensional embeddings for images in a shared vector space
with text, enabling multimodal search, retrieval, and similarity operations.

This guide covers profiling NIM image embedding endpoints with image inputs.

---

## Overview

### Model Details

| Property | Value |
|----------|-------|
| Model | C-RADIOv3-H (Huge, 653M params) |
| Embedding Dimension | 1024 |
| Max Resolution | 2048x2048 |
| Max Batch Size | 64 images per request |

### Request Types

| Request Type | Use Case | Input |
|--------------|----------|-------|
| `query` | Single image | One base64 image |
| `bulk_image` | Multiple images | Up to 64 same-size images |

### Key Features

- **1024-dim Embeddings**: High-quality vector representations from images
- **Pyramidal Patching**: Multi-scale embeddings via configurable grids (e.g., 1x1 + 3x3 + 5x5 = 35 patches)
- **Bulk Processing**: Process up to 64 images per request
- **OpenAI-Compatible**: Standard `/v1/embeddings` endpoint

---

## Section 1. Profile with Synthetic Images

The quickest way to benchmark is using synthetic images generated by AIPerf:

### Single Synthetic Image

```bash
aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --image-batch-size 1 \
    --image-width-mean 512 \
    --image-height-mean 512 \
    --request-count 5 \
    --concurrency 1
```

### Multiple Synthetic Images (Bulk)

```bash
aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --image-batch-size 4 \
    --image-width-mean 512 \
    --image-height-mean 512 \
    --request-count 50 \
    --concurrency 4
```

### Synthetic Image Options

| Option | Default | Description |
|--------|---------|-------------|
| `--image-batch-size` | 0 | Number of images per request |
| `--image-width-mean` | 100 | Mean width in pixels |
| `--image-height-mean` | 100 | Mean height in pixels |
| `--image-width-stddev` | 0 | Width variation (0 = uniform) |
| `--image-height-stddev` | 0 | Height variation (0 = uniform) |
| `--image-format` | png | Format: `png`, `jpeg`, or `random` |

---

## Section 2. Profile with Custom Images

For benchmarking with your own images, create a JSONL input file:

### Single Image

```bash
cat <<EOF > single_image.jsonl
{"images": ["your_image.jpg"]}
EOF

aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --input-file single_image.jsonl \
    --custom-dataset-type single_turn \
    --request-count 1
```

AIPerf automatically loads local image files and converts them to base64.

### Multiple Images (Bulk)

```bash
cat <<EOF > bulk_images.jsonl
{"images": ["image1.jpg", "image2.jpg", "image3.jpg"]}
EOF

aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --input-file bulk_images.jsonl \
    --custom-dataset-type single_turn \
    --request-count 1
```

**Note**: Bulk requests require all images to have the same dimensions.

---

## Section 3. Pyramidal Patching

Pyramidal patching enables multi-scale image representations by dividing images into grids
at different resolutions. Each pyramid level produces multiple embeddings:

```
pyramid: [[1,1], [3,3], [5,5]]

1x1 = 1 patch   (full image)
3x3 = 9 patches
5x5 = 25 patches
─────────────────
Total: 35 embeddings per image
```

### Profile with Pyramidal Patching

```bash
aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --input-file single_image.jsonl \
    --custom-dataset-type single_turn \
    --request-count 1 \
    --extra-inputs '{"pyramid": [[1,1],[3,3],[5,5]]}'
```

### Common Pyramid Configurations

| Configuration | Patches | Use Case |
|---------------|---------|----------|
| `[[1,1]]` | 1 | Single global embedding |
| `[[1,1],[2,2]]` | 5 | Light multi-scale |
| `[[1,1],[3,3]]` | 10 | Moderate detail |
| `[[1,1],[3,3],[5,5]]` | 35 | High detail |

---

## Section 4. Extra Parameters

Configure additional API parameters via `--extra-inputs`:

```bash
aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --input-file single_image.jsonl \
    --custom-dataset-type single_turn \
    --request-count 1 \
    --extra-inputs '{"pyramid": [[1,1],[3,3],[5,5]], "max_pixels": 50176, "encoding_format": "float"}'
```

### Available Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `pyramid` | int[][] | null | Patch grid, e.g., `[[1,1],[3,3],[5,5]]` |
| `max_pixels` | int | 50176 | Max pixels per image |
| `encoding_format` | string | `"float"` | `float` or `base64` |
| `request_type` | string | auto | Override: `query` or `bulk_image` |

---

## Section 5. API Request Format

The NIM Image Embeddings endpoint (`POST /v1/embeddings`) accepts the following payload:

### Single Image Request

```json
{
    "model": "nvidia/c-radio-v3-h",
    "input": "data:image/jpeg;base64,/9j/4AAQ...",
    "request_type": "query",
    "pyramid": [[1,1],[3,3],[5,5]],
    "max_pixels": 50176
}
```

### Bulk Image Request

```json
{
    "model": "nvidia/c-radio-v3-h",
    "input": ["data:image/jpeg;base64,...", "data:image/jpeg;base64,..."],
    "request_type": "bulk_image",
    "pyramid": [[1,1],[3,3]]
}
```

### Response Format

```json
{
    "object": "list",
    "model": "nvidia/c-radio-v3-h",
    "data": [
        {
            "object": "embedding",
            "index": 0,
            "embedding": [0.123, -0.456, ...],
            "patch_metadata": null
        }
    ],
    "usage": {
        "prompt_tokens": 0,
        "total_tokens": 0,
        "num_images": 1,
        "num_patches": 0
    }
}
```

### Response Fields

| Field | Description |
|-------|-------------|
| `data[].embedding` | The embedding vector (1024 dimensions) |
| `data[].patch_metadata` | Pyramidal patch information (when pyramid is used) |
| `usage.num_images` | Number of images processed |
| `usage.num_patches` | Total patches processed |

---

## Section 6. Request Type Detection

AIPerf automatically determines the `request_type` based on input:

| Input | request_type | input format |
|-------|--------------|--------------|
| Single image | `query` | string |
| Multiple images | `bulk_image` | array |

Override automatic detection with `--extra-inputs`:

```bash
aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --input-file single_image.jsonl \
    --custom-dataset-type single_turn \
    --request-count 1 \
    --extra-inputs request_type:bulk_image
```

---

## Section 7. Text Inputs (Alternative)

The endpoint also supports text inputs for generating embeddings in the same vector space
as images, useful for cross-modal search scenarios.

### Synthetic Text Profile

```bash
aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --synthetic-input-tokens-mean 100 \
    --synthetic-input-tokens-stddev 20 \
    --request-count 100 \
    --concurrency 8
```

### Custom Text Input File

```bash
cat <<EOF > text_queries.jsonl
{"texts": ["a photo of a cat sitting on a couch"]}
{"texts": ["a landscape image of mountains at sunset"]}
{"texts": ["an abstract painting with geometric shapes"]}
EOF
```

```bash
aiperf profile \
    --model nvidia/c-radio-v3-h \
    --endpoint-type nim_image_embeddings \
    --url localhost:8000 \
    --input-file text_queries.jsonl \
    --custom-dataset-type single_turn \
    --request-count 5
```

Text request types: `query` (single text) or `bulk_text` (multiple texts, up to 64).

---

## Metrics

NIM Image Embeddings endpoints are non-streaming:

| Metric | Description |
|--------|-------------|
| `request_latency` | Total time from request start to response completion |
| `request_throughput` | Requests completed per second |
| `time_per_request` | Average time per request |

Streaming metrics (`time_to_first_token`, `inter_token_latency`) are not applicable.

---

## Troubleshooting

### Common Issues

1. **"Max_tokens is provided but is not supported"**: Remove `--synthetic-output-tokens-mean`
   from your command. Embedding endpoints don't generate output tokens.

2. **Pyramid format errors**: Ensure pyramid is valid JSON with double quotes:
   `'{"pyramid": [[1,1],[3,3]]}'`

3. **Out of memory**: Reduce image resolution or pyramid complexity:
   ```bash
   --extra-inputs '{"max_pixels": 25088, "pyramid": [[1,1],[2,2]]}'
   ```

4. **Batch size limits**: Maximum 64 images per request. Use multiple requests
   with appropriate concurrency for larger datasets.

5. **Bulk image dimension mismatch**: All images in a bulk request must have
   the same dimensions.

---

## Reference

- [C-RADIOv3-H on HuggingFace](https://huggingface.co/nvidia/C-RADIOv3-H)
- [RADIO GitHub](https://github.com/NVlabs/RADIO)
